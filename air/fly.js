import*as d3 from"https://cdn.jsdelivr.net/npm/d3@7/+esm";import moment from"https://unpkg.com/moment@2.29.4/dist/moment.js";const MGN=50;let chart,parent,parentId,lastModifiedId,legendEl,legendId,height,x,y,pinpoint,xAxis,addCircle,start,end,width=750;const boxHeight=10,margin={top:20,right:10,bottom:20,left:130},kac_states=["출발","수속중","탑승구 변경","탑승장 입장","탑승중","마감예정","탑승최종","도착","결항","지연","회항"],ic_states=["출발","체크인오픈","탑승준비","탑승중","마감예정","탑승마감","착륙","도착","결항","지연","회항"];let states,color,IST,last_airport;const trans=()=>d3.transition().duration(500);let tooltip,createTooltip=function(t){t.classed("tooltip",!0)};const getTooltipContent=function(t){return`<div><span>비행기번호</span>: <b>${t.plane}</b></div>\n\t\t<div><span>상태</span>: <b>${t.state}</b></div>\n\t\t<div><span class="">플랫폼</span>: <b>${t.gate}</b></div>\n\t\t<div><span class="">예정시간</span>: <b>${moment(t.schedule).format("MM-DD HH:mm")}</b></div>\n\t\t`};let searchInput;function _search(){search(this.value.trim())}function search(t){if(t){const e=new RegExp(t,"i");chart.classed("g-searching",!0),chart.selectAll("circle").classed("g-match",(t=>e.test(t.plane)));let a=d3.selectAll(".g-match");if(1==a.nodes().length){a.classed("g-active",!0);let t=a.datum();return void tooltip.style("opacity",1).style("left",window.innerWidth/2-tooltip.node().offsetWidth/2+"px").style("top","200px").style("background-color",color(t.state)).html(getTooltipContent(t))}}else searchInput.property("value","");tooltip.style("opacity",0),chart.classed("g-searching",!1),chart.selectAll("circle").classed("g-match",!1).classed("g-active",!1)}function getHours(){let t=new Date,e=(new Date).getHours();return[moment(t.setHours(e-1)).format("HHmm"),moment(t.setHours(e+2)).format("HHmm")]}function init(t){if(d3.select(lastModifiedId).text(moment(new Date).format("YYYY-MM-DD HH:mm:ss")),last_airport=t||"CJJ",IST="ICN"==last_airport?"icn":"kac","icn"!=IST?(states=kac_states,color=d3.scaleOrdinal().domain(kac_states).range(["#000075","#3cb44b","#f58231","#9A6324","#808000","#42d4f4","#469990","#800000","#e6194B","#f032e6","#911eb4"]).unknown("#ccc")):(states=ic_states,color=d3.scaleOrdinal().domain(states).range(["#000075","#3cb44b","#9A6324","#808000","#42d4f4","#469990","#4363d8","#800000","#e6194B","#f032e6","#911eb4"]).unknown("#ccc")),1){const t=getHours();fetch("https://statkorea.modoree.kr/airport?sh="+t[0]+"&eh="+t[1]+"&branch="+last_airport).then((async t=>{let e=await t.json(),a=[d3.csvParse(e.i),d3.csvParse(e.o)],n=new Array;for(const t of a)n=n.concat(t.map((t=>({...t,gate:+t.gate,schedule:new Date(t.schedule),update_schedule:new Date(t.update_schedule)}))));start=d3.min(n,(t=>{let e=d3.min([t.schedule,t.update_schedule]);return new Date(moment(e).add(-3,"m"))})),end=d3.max(n,(t=>{let e=d3.max([t.schedule,t.update_schedule]);return new Date(moment(e).add(3,"m"))})),go(n,start,end)})).catch((function(t){}))}else Promise.all([d3.csv("../files/fly-in.csv"),d3.csv("../files/fly-out.csv")]).then((function(t){let e=new Array;for(const a of t)e=e.concat(a.map((t=>({...t,gate:+t.gate,schedule:new Date(t.schedule),update_schedule:new Date(t.update_schedule)}))));start=d3.min(e,(t=>{let e=d3.min([t.schedule,t.update_schedule]);return new Date(moment(e).add(-3,"m"))})),end=d3.max(e,(t=>{let e=d3.max([t.schedule,t.update_schedule]);return new Date(moment(e).add(3,"m"))})),go(e,start,end)})).catch((function(t){}))}function injectAirlines(t){d3.selectAll("#airline option").remove(),d3.select("#airline").on("change",(function(t){})).selectAll(null).data(t).enter().append("option").text((t=>t)).attr("value",(t=>t))}function go(t,e,a){parent.style.height=window.innerHeight-200-50-60+"px",parent.style.overflowY="auto";let n=d3.group(t,(t=>t.airline)),l=Array.from(n.keys()).sort(d3.ascending),r=getGroupData(t);height=_height(r),x=d3.scaleTime().domain([e,a]).range([0,width-margin.left]),xAxis=_xAxis(x,height),y=_y(r,l),pinpoint=_pinpoint(x,y,r),addCircle=_addCircle(n),_legend(summarize(t)),chart=_chart(l,e,a)}function getGroupData(t){let e=new Map;return d3.group(t,(t=>t.airline)).forEach(((t,a)=>{let n=d3.group(t,(t=>t.type)),l={};n.forEach(((t,e)=>{let a=d3.rollup(t,(t=>t.length),(t=>t.schedule)),n=new Map;a.forEach(((t,e)=>{t>0&&n.set(e.getTime(),{count:t,left:t})}));let r=d3.max(a.values());l[e]={max:r,multiple:n}})),l.max=(l.I?.max||1)+(l.O?.max||1),e.set(a,l)})),e}function _height(t){let e=d3.sum(t.values(),(t=>t.max));return margin.top+12*e+50*(t.size+1)+margin.bottom}function _xAxis(t,e){return a=>a.attr("id","x-axis").attr("transform",`translate(${margin.left}, ${margin.top})`).call(d3.axisTop(t)).call((t=>t.selectAll(".tick line").attr("stroke-opacity",.1).attr("y2",e-margin.bottom))).call((t=>t.selectAll(".domain").remove()))}function _y(t,e){let a=margin.top,n=new Array;return e.forEach((e=>{const l=t.get(e);let r=l.O?.max||1;r>6&&(r=6);let i=l.I?.max||1;i>6&&(i=6),a+=50,a+=12*r,n.push(a),a+=12*i})),d3.scaleOrdinal().domain(e).range(n)}function loc(t,e,a){return"-"==t?e*a*-1:e*a*1}function _pinpoint(t,e,a){return function(n){let l=d3.select(this),r=a.get(n.airline)[n.type].multiple,i="O"==n.type?"-":"+";if(!r||!r.has(n.schedule.getTime()))return void l.attr("opacity",.1).attr("cy",e(n.airline)).attr("cx",margin.left+t(new Date(n.schedule))).attr("opacity",.9).attr("cy",e(n.airline)+loc(i,1,12));if(r.has(n.schedule.getTime())){let a=r.get(n.schedule.getTime()),o=a.count,s=a.left--;if(o<=6)return void l.attr("opacity",.1).attr("cy",e(n.airline)).attr("cx",margin.left+t(new Date(n.schedule))).attr("opacity",.9).attr("cy",(t=>{let a=loc(i,s,12);return e(t.airline)+a}))}let o=Math.floor((count-left)/2),s=(count-left)%2==0,c=s?"+":"-";s||o++,l.attr("opacity",.1).attr("cy",e(n.airline)).attr("cx",margin.left+t(new Date(n.schedule))+loc(c,1,6)).attr("opacity",.9).attr("cy",e(n.airline)+loc(i,o,12))}}function _addCircle(t){return function(e){let a=d3.select(this).selectAll("circle").data(t.get(e)).join("circle").attr("r",5).attr("stroke-width",.5).attr("stroke","black").attr("fill",(t=>color(t.state))).on("mousemove",(function(t,e){search(),d3.select(this).classed("g-active",!0);let a=t.pageX-tooltip.node().offsetWidth,n=t.pageY-tooltip.node().offsetHeight;tooltip.style("opacity",1).style("top",n+"px").style("left",a+"px").style("background-color",color(e.state)).html(getTooltipContent(e)),d3.select("#"+e.airline+" text").attr("font-weight","bold")})).on("mouseleave",(function(t,e){d3.select(this).classed("g-active",!1),tooltip.style("opacity",0),d3.select("#"+e.airline+" text").attr("font-weight","")}));a.each(pinpoint)}}function summarize(t){return d3.rollup(t,(t=>t.length),(t=>t.state))}const min_width=470;let legendx,kac_legend,icn_legend;function _legend(t){if(width<470)return void(legendEl.style.display="none");if(0==document.querySelectorAll("#"+IST+"-legend").length)return void("icn"==IST?(icn_legend=legend(t),kac_legend?.attr("display","none")):(kac_legend=legend(t),icn_legend?.attr("display","none")));let e="icn"==IST?icn_legend:kac_legend;icn_legend?.attr("display","icn"==IST?"block":"none"),kac_legend?.attr("display","kac"==IST?"block":"none"),e.selectAll(".size").transition(trans()).each((function(e){d3.select(this).text((e=>t.get(e)||0))}))}function legend(t){let e=470+Math.floor(Math.sqrt(width-470));legendx=d3.scaleLinear([0,5],[0,e]);let a=d3.select(legendId).append("svg").attr("text-anchor","start").attr("height",60).attr("width",e).attr("id",IST+"-legend").attr("transform","translate(20 0)");return a.append("g").call((t=>t.selectAll("rect").data(states).join("rect").attr("width",23).attr("height",15).attr("x",0).attr("rx",3).attr("opacity",0).transition(trans()).attr("opacity",1).attr("x",((t,e)=>legendx(e%5))).attr("y",((t,e)=>18*Math.floor(e/5))).attr("fill",(t=>color(t))))).call((t=>t.selectAll("text").data(states).join("text").attr("x",0).attr("dy","0.2em").attr("font-size",10).attr("fill",(t=>color(t))).attr("class","label").attr("opacity",0).transition(trans()).attr("opacity",1).attr("x",((t,e)=>legendx(e%5)+27)).attr("y",((t,e)=>18*Math.floor(e/5)+10)).text((t=>t)))),a.append("g").selectAll("text").data(states).join("text").attr("text-anchor","end").attr("font-weight","bold").attr("x",0).attr("dy","0.15em").attr("font-size","8pt").attr("fill","snow").attr("class","size").attr("opacity",0).transition(trans()).attr("opacity",1).attr("x",((t,e)=>legendx(e%5)+18)).attr("y",((t,e)=>18*Math.floor(e/5)+10)).text((e=>t.get(e)||0)),a}function _chart(t,e,a){let n=d3.select("#chart").attr("width",width).attr("height",height).attr("viewBox",[0,0,width,height]).attr("transform",((t,e)=>`translate(0 ${margin.top})`));n.call((t=>t.selectAll("g").remove())).call((t=>t.selectAll("line").remove())),n.append("g").call(xAxis),n.append("g").attr("transform",((t,e)=>`translate(${margin.left} ${height-margin.bottom})`)).call(d3.axisBottom(x)).call((t=>t.selectAll(".domain").remove()));const l=n.append("line").attr("class","line").attr("display","none").attr("y1",margin.top).attr("y2",height-margin.bottom).attr("stroke","rgba(0,0,0,0.2)").style("pointer-events","none").attr("transform",`translate(${margin.left+20})`),r=n.append("g").style("font","11px sans-serif").selectAll("g").data(t).join("g").attr("id",(t=>t));return r.append("line").attr("stroke","#777").attr("x1",margin.left+x(e)).attr("x2",width).attr("y1",(t=>y(t))).attr("y2",(t=>y(t))),r.append("text").attr("text-anchor","end").attr("x",margin.left-10).attr("y",(t=>y(t))).attr("dy","0.35em").text((t=>t)),r.each(addCircle),n.on("mousemove",(t=>{let[a,n]=d3.pointer(t);x(e)+margin.left>=a||l.attr("transform",`translate(${a} 0)`)})).on("mouseover",(t=>{d3.select(".line").attr("display","block")})).on("mouseout",(t=>{d3.select(".line").attr("display","none")})),n}export default{tooltipId:function(t){return tooltip=d3.select("#"+t).call(createTooltip),this},searchId:function(t){return searchInput=d3.select("#"+t).on("search",_search).on("keyup",_search),this},legendEl:function(t){return legendEl=t,legendId="#"+t.id,this},parentEl:function(t){return parent=t,parentId="#"+t.id,width=t.offsetWidth-20,this},lastModifiedId:function(t){return lastModifiedId="#"+t,this},reload:function(){init(last_airport)},build:function(t){return init(t),this}};