import*as d3 from"https://cdn.jsdelivr.net/npm/d3@7/+esm";import{metropolitans}from"../js/statkorea.min.js";let parentId,svg,orders;var margin={top:50,right:20,bottom:10,left:80},width=420,height=420,x=d3.scaleBand().rangeRound([0,width]),z=d3.scaleLinear().domain([-500,7e3]).clamp(!0),c=d3.scaleOrdinal().range(d3.schemeCategory10).domain(["SD","DN","DG","CC","GW","HN","JJ"]);function mouseover(){const t=d3.select(this).data()[0];d3.selectAll(".row_ text").classed("active",(function(e,r){return r==t.y})),d3.selectAll(".column text").classed("active",(function(e,r){return r==t.x}))}function mouseout(){d3.selectAll("text").classed("active",!1)}function init(){svg=d3.select(parentId).append("svg").attr("width",width+margin.left+margin.right).attr("height",height+margin.top+margin.bottom).append("g").attr("transform","translate("+margin.left+","+margin.top+")"),d3.json("../files/airways.json").then((function(t){let e=[],r=t.nodes,n=r.length;var a;function a(t){d3.select(this).selectAll(".cell").data(t.filter((t=>t.z))).enter().append("rect").attr("class","cell").attr("x",(function(t){return x(t.x)})).attr("width",x.bandwidth()).attr("height",x.bandwidth()).style("fill-opacity",(t=>z(t.z))).style("fill",(function(t){return r[t.x].group==r[t.y].group?c(r[t.x].group):null})).on("mouseover",mouseover).on("mouseout",mouseout).append("title").text((t=>t.z+"ê±´"))}r.forEach((function(t,r){t.index=r,t.count=0,e[r]=d3.range(n).map((function(t){return{x:t,y:r,z:0}}))})),t.links.forEach((function(t){e[t.source][t.target].z+=t.value,e[t.target][t.source].z+=t.value,e[t.source][t.source].z+=t.value,e[t.target][t.target].z+=t.value,r[t.source].count+=t.value,r[t.target].count+=t.value})),orders={name:d3.range(n).sort((function(t,e){return d3.ascending(r[t].name,r[e].name)})),count:d3.range(n).sort((function(t,e){return r[e].count-r[t].count})),group:d3.range(n).sort((function(t,e){return r[e].group-r[t].group}))},x.domain(orders.name),svg.append("rect").attr("class","background").attr("width",width).attr("height",height),(a=svg.selectAll(".row_").data(e).enter().append("g").attr("class","row_").attr("transform",(function(t,e){return"translate(0,"+x(e)+")"})).each(a)).append("line").attr("x2",width),a.append("text").attr("x",-6).attr("y",x.bandwidth()/2).attr("dy",".32em").attr("text-anchor","end").text((function(t,e){return r[e].name}));var o=svg.selectAll(".column").data(e).enter().append("g").attr("class","column").attr("transform",(function(t,e){return"translate("+x(e)+")rotate(-90)"}));o.append("line").attr("x2",-width),o.append("text").attr("x",15).attr("y",x.bandwidth()/2-10).attr("dy",".32em").attr("text-anchor","start").attr("transform",(function(t,e){return"translate(0) rotate(45)"})).text((function(t,e){return r[e].name})),_legend()}))}const options=["count","group","name"];var timeout=setInterval((function(){let t=options.shift();options.push(t),order(t),d3.select("#order").property("value",t)}),3e4);function order(t){x.domain(orders[t]);var e=svg.transition().duration(2500);e.selectAll(".row_").delay((function(t,e){return 3*x(e)})).attr("transform",(function(t,e){return"translate(0,"+x(e)+")"})).selectAll(".cell").delay((function(t){return 3*x(t.x)})).attr("x",(function(t){return x(t.x)})),e.selectAll(".column").delay((function(t,e){return 3*x(e)})).attr("transform",(function(t,e){return"translate("+x(e)+",0) rotate(-90)"}))}function _legend(){let t=width,e=t+Math.sqrt(width-t),r=d3.transition().duration(500),n=d3.scaleBand().domain(metropolitans.map((t=>t.code))).range([0,e]);d3.select(parentId).append("svg").attr("text-anchor","start").attr("id","legend").attr("height",20).attr("width",e).attr("transform","translate(20 0)").append("g").call((t=>t.selectAll("circle").data(metropolitans).join("circle").attr("r",5).attr("cx",0).attr("cy",0).attr("opacity",0).transition(r).attr("opacity",1).attr("cx",(({code:t})=>n(t))).attr("fill",(({code:t})=>c(t))))).call((t=>t.selectAll("text").data(metropolitans).join("text").attr("x",0).attr("y",3).attr("dy","0.2em").attr("font-size",10).attr("opacity",0).transition(r).attr("opacity",1).attr("x",(({code:t})=>n(t)+7)).text((({value:t})=>t))))}export default{parentEl:function(t){return parentId="#"+t.id,this},order:function(t){return d3.select(t).on("change",(function(){clearTimeout(timeout),order(this.value)})),this},build:function(){return init(),this}};